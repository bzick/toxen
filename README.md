Toxen
=====

Toxen (от _To extension_) - преобразователь PHP библиотеки в PHP расширение.

Суть проекта преобразовать набор PHP классов в PHP расширение с тем же набором классов для PHP.

`Project\MyClass::method($a)` из lib/myclass.php -> Toxen преобразования -> `Project\MyClass::method($a)` из **project.so**

Какие преследуются цели:

* Ускорение работы. За счет:
	- Все классы сразу вгружены в память
	- Ссылки на классы, методы, переменные закешированы на уровсе Си
	- Оптимизация методов. Если парсер однозначно видит тип переменной на протяжении всего метода то исользуется алгоритмы работы с примитивным типом вместо контейнера zval.
	- Обход call-scope. При жесткой опимизации методы можно вызывать как Си функцию, минуя внутренний механизм PHP вызова методов. В этом случае отладка усложняется и исключения порожденные в расширении могут недосчитаться некторых уровней выова.
	- функции PHP, при необходимости, могут быть заменены на более оптимизированные варианты во врмемя преобразования.
* В отличии от HipHop или KPHP нет необходимости менять что-либо в проекте, так как все классы остаются таковыми, но из расширения.
* Ранее закрытые проекты могут распространяться свободно, в виде расширения.
* Если с расширением что-то не так, то можно быстро переключиться на обычный PHP код.
* Интеграция с composer  позволит собрать проект со всеми зависимостями в одно расширение.
* Сопутсвующие анализ кода и генерация документации для расширения.
* Возможность подключить и использовать Си библиотеки описываю работу с нимим в PHP [в далеком будущем]

### Установка

Toxen идет как зависимость через composer. Лучший вариант toxen должен быть как dev зависимость. После подгрузки пакета toxen в папке `vendor/bin/` появляется исполняемый файл `toxen`.

### Процесс

- Запуск Toxen, считывание файла конфигурации toxen.json из корня проекта.
- Composer предоставляет classmap всех классов в проекте и его зависимостях (исключая dev зависимости).
- Toxen генерирует необходимые для расширения файлы: config.m4, php_{$name}.c, php_{$name}.h и прочее.
- Toxen последовательно обходит все классы для каждого создается .h файл
- Для каждого класса Toxen перебирает константы и свойства, регистрируя их в расширении (используется Reflection).
- Для каждого класса Toxen перебирает методы, анализирую аргументы и док-блок для определения типа переменных с которыми придется работать (используется Reflection).
- Для тела каждого метода Toxen использует [PHP-Parser](https://github.com/nikic/PHP-Parser) что бы разобрать код на лексемы, которые будут собраны в виде Си кода.
- После завершения работы над классом создается .c файл где описан класс для Zend Engine.
- Компиляция исходников в .so расширение [опционально]
- Запуск тестов проекта, но уже для расширения если они есть, с целью диагностики целостности расширения [опционально]
- Сбор статистики по формату, документированию кода [опционально]

### Замечания

- Zend Engine имеет множество функций для работы с контейнером zval

### Известные проблемы

- Тяжело будет иммитировать `yield` в Си. Пока есть идея решения через `GOTO`.
- Проблема если класс расширяет другой класс не входящий в состав PHP, PHP расширений или проекта. Создать его нет возможности так как нет родительского класса. Как-то динамически это надо делать.
